name: Benchmarks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse-dev

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: Run benchmarks
        run: go test -bench=. -benchmem -count=5 ./internal/dedup/... | tee benchmark-output.txt

      # Statistical regression detection using benchstat
      - name: Compare with baseline (benchstat)
        id: benchstat
        run: |
          if [ -f benchmarks/baseline.txt ]; then
            echo "Comparing against baseline..."
            if benchstat benchmarks/baseline.txt benchmark-output.txt | tee benchstat-output.txt; then
              # Check for significant regressions
              if bash scripts/check-benchstat.sh benchstat-output.txt; then
                echo "regression=false" >> $GITHUB_OUTPUT
              else
                echo "regression=true" >> $GITHUB_OUTPUT
              fi
            else
              echo "benchstat failed to parse benchmarks (possible corrupted baseline). Skipping regression check."
              echo "regression=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No baseline file found, skipping comparison"
            echo "regression=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR with benchstat results
        if: github.event_name == 'pull_request' && steps.benchstat.outputs.regression == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('benchstat-output.txt', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ⚠️ Benchmark Regression Detected\n\nStatistically significant performance regression detected by benchstat:\n\n\`\`\`\n${output}\n\`\`\`\n\nPlease review the changes to ensure the regression is acceptable.`
            });

      # Visualization using github-action-benchmark
      - name: Store benchmark result for visualization
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: 'go'
          output-file-path: benchmark-output.txt
          github-token: ${{ secrets.GITHUB_TOKEN }}
          # Only push to gh-pages on main branch pushes
          auto-push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          # Disable alerts from this action (using benchstat instead)
          alert-threshold: '200%'
          comment-on-alert: false
          fail-on-alert: false
          # Store benchmark data on gh-pages branch
          gh-pages-branch: gh-pages
          benchmark-data-dir-path: benchmarks

      # Update baseline on main branch
      - name: Update baseline
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          cp benchmark-output.txt benchmarks/baseline.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add benchmarks/baseline.txt
          git diff --staged --quiet || git commit -m "Update benchmark baseline [skip ci]"
          git push
