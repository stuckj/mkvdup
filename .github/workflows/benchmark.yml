name: Benchmarks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          # Use PAT for checkout on main pushes (needed for baseline update push).
          # Fall back to default GITHUB_TOKEN for PRs (including dependabot).
          token: ${{ secrets.BENCHMARK_PAT || github.token }}

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse-dev

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@v0.0.0-20260209182753-b57e4e371b65

      - name: Run benchmarks
        run: |
          go test -bench=. -benchmem -count=10 \
            ./internal/dedup/... \
            ./internal/mkv/... \
            ./internal/source/... \
            ./internal/matcher/... \
            | tee benchmark-output.txt

      # Statistical regression detection using benchstat
      - name: Compare with baseline (benchstat)
        id: benchstat
        run: |
          set -o pipefail  # Ensure pipe returns exit code of first failing command
          if [ -f benchmarks/baseline.txt ]; then
            echo "Comparing against baseline..."
            if benchstat benchmarks/baseline.txt benchmark-output.txt | tee benchstat-output.txt; then
              # Check for significant regressions and capture the summary
              if bash scripts/check-benchstat.sh benchstat-output.txt | tee regression-summary.txt; then
                echo "regression=false" >> $GITHUB_OUTPUT
              else
                echo "regression=true" >> $GITHUB_OUTPUT
              fi
            else
              echo "benchstat failed to parse benchmarks (possible corrupted baseline). Skipping regression check."
              echo "regression=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No baseline file found, skipping comparison"
            echo "regression=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR with benchstat results
        if: github.event_name == 'pull_request' && steps.benchstat.outputs.regression == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const benchstatOutput = fs.readFileSync('benchstat-output.txt', 'utf8');
            const regressionSummary = fs.readFileSync('regression-summary.txt', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ⚠️ Benchmark Regression Detected\n\n${regressionSummary}\n\n<details>\n<summary>Full benchstat output</summary>\n\n\`\`\`\n${benchstatOutput}\n\`\`\`\n</details>\n\nPlease review the changes to ensure the regression is acceptable.`
            });

      # Visualization using github-action-benchmark
      - name: Store benchmark result for visualization
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: 'go'
          output-file-path: benchmark-output.txt
          # Use PAT for gh-pages push on main, fall back to GITHUB_TOKEN for PRs
          github-token: ${{ secrets.BENCHMARK_PAT || github.token }}
          # Only push to gh-pages on main branch pushes
          auto-push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          # Disable alerts from this action (using benchstat instead)
          alert-threshold: '200%'
          comment-on-alert: false
          fail-on-alert: false
          # Store benchmark data on gh-pages branch
          gh-pages-branch: gh-pages
          benchmark-data-dir-path: benchmarks

      # Update baseline on main branch
      - name: Update baseline
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Validate that BENCHMARK_PAT was configured (checkout would have used it)
          if [ "${{ secrets.BENCHMARK_PAT }}" = "" ]; then
            echo "WARNING: BENCHMARK_PAT secret not configured. Skipping baseline update."
            exit 0
          fi
          cp benchmark-output.txt benchmarks/baseline.txt
          git config user.name "stuckj"
          git config user.email "stuckj@users.noreply.github.com"
          git add benchmarks/baseline.txt
          git diff --staged --quiet || git commit -m "Update benchmark baseline [skip ci]"
          # Pull any changes that occurred during the workflow run
          git pull --rebase origin main
          git push
