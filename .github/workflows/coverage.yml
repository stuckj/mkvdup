name: Coverage

on:
  workflow_run:
    workflows: ["CI", "Integration Tests"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  coverage:
    name: Merge Coverage
    runs-on: ubuntu-latest
    # Only run on successful workflow completions
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}
          token: ${{ secrets.BENCHMARK_PAT }}

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse-dev

      - name: Download unit coverage artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ci.yml
          commit: ${{ github.event.workflow_run.head_sha }}
          name: unit-coverage
          path: ./coverage-artifacts
        continue-on-error: true

      - name: Download integration coverage artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: integration.yml
          commit: ${{ github.event.workflow_run.head_sha }}
          name: integration-coverage
          path: ./coverage-artifacts
        continue-on-error: true

      - name: List downloaded artifacts
        run: ls -la ./coverage-artifacts/ || echo "No artifacts downloaded"

      - name: Install gocovmerge
        run: go install github.com/wadey/gocovmerge@latest

      - name: Merge coverage profiles
        id: merge
        run: |
          # Check what coverage files we have
          UNIT_COV=""
          INT_COV=""

          if [ -f "./coverage-artifacts/coverage.out" ]; then
            UNIT_COV="./coverage-artifacts/coverage.out"
            echo "Found unit coverage"
          fi

          if [ -f "./coverage-artifacts/integration-coverage.out" ]; then
            INT_COV="./coverage-artifacts/integration-coverage.out"
            echo "Found integration coverage"
          fi

          # Merge available coverage files
          if [ -n "$UNIT_COV" ] && [ -n "$INT_COV" ]; then
            echo "Merging unit and integration coverage"
            echo "coverage_type=merged" >> $GITHUB_OUTPUT
            gocovmerge "$UNIT_COV" "$INT_COV" > merged-coverage.out
          elif [ -n "$UNIT_COV" ]; then
            echo "Using unit coverage only"
            echo "coverage_type=unit" >> $GITHUB_OUTPUT
            cp "$UNIT_COV" merged-coverage.out
          elif [ -n "$INT_COV" ]; then
            echo "Using integration coverage only"
            echo "coverage_type=integration" >> $GITHUB_OUTPUT
            cp "$INT_COV" merged-coverage.out
          else
            echo "No coverage files found"
            exit 1
          fi

      - name: Generate coverage reports
        id: coverage
        run: |
          # Generate function coverage summary
          go tool cover -func=merged-coverage.out | tee coverage-summary.txt

          # Extract total coverage percentage
          COVERAGE=$(go tool cover -func=merged-coverage.out | grep total | awk '{print $3}' | tr -d '%')
          echo "Total coverage: ${COVERAGE}%"
          echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT

          # Generate HTML report
          go tool cover -html=merged-coverage.out -o coverage.html

          # Generate JSON for badge and tracking
          cat > coverage.json << EOF
          {
            "coverage": ${COVERAGE},
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.event.workflow_run.head_sha }}",
            "trigger_workflow": "${{ github.event.workflow_run.name }}",
            "coverage_type": "${{ steps.merge.outputs.coverage_type }}"
          }
          EOF

      - name: Find associated PR
        id: find-pr
        if: github.event.workflow_run.head_branch != 'main'
        uses: actions/github-script@v8
        with:
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${{ github.event.workflow_run.head_branch }}`,
              state: 'open'
            });
            if (prs.data.length > 0) {
              core.setOutput('pr_number', prs.data[0].number);
              return prs.data[0].number;
            }
            return '';

      - name: Comment coverage on PR
        if: steps.find-pr.outputs.pr_number
        continue-on-error: true
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('coverage-summary.txt', 'utf8');
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const coverageType = '${{ steps.merge.outputs.coverage_type }}';
            const prNumber = ${{ steps.find-pr.outputs.pr_number }};

            let typeNote = '';
            if (coverageType === 'unit') {
              typeNote = '\n\n*Note: Integration coverage not yet available for this commit.*';
            } else if (coverageType === 'integration') {
              typeNote = '\n\n*Note: Unit coverage not yet available for this commit.*';
            }

            // Find existing coverage comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const coverageComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('## Test Coverage Report')
            );

            const body = `## Test Coverage Report

            **Total Coverage: ${coverage}%**${typeNote}

            <details>
            <summary>Coverage by function</summary>

            \`\`\`
            ${summary}
            \`\`\`

            </details>`;

            if (coverageComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: coverageComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }

      - name: Publish coverage to gh-pages
        if: github.event.workflow_run.head_branch == 'main'
        run: |
          # Validate that BENCHMARK_PAT was configured
          if [ "${{ secrets.BENCHMARK_PAT }}" = "" ]; then
            echo "WARNING: BENCHMARK_PAT secret not configured. Skipping gh-pages publish."
            exit 0
          fi

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Save coverage files
          mkdir -p /tmp/coverage
          cp coverage.html /tmp/coverage/
          cp coverage.json /tmp/coverage/
          cp coverage-summary.txt /tmp/coverage/
          cp merged-coverage.out /tmp/coverage/

          # Switch to gh-pages branch
          git fetch origin gh-pages
          git checkout gh-pages

          # Create coverage directory if it doesn't exist
          mkdir -p coverage

          # Copy coverage files
          cp /tmp/coverage/coverage.html coverage/index.html
          cp /tmp/coverage/coverage.json coverage/
          cp /tmp/coverage/coverage-summary.txt coverage/
          cp /tmp/coverage/merged-coverage.out coverage/coverage.out

          # Commit and push
          git add coverage/
          git diff --staged --quiet || git commit -m "Update coverage report [skip ci]"
          git pull --rebase origin gh-pages
          git push
