name: Coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_cache:
        description: 'Skip cache and regenerate testdata'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  coverage:
    name: Full Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse-dev fuse3 wget ffmpeg

      - name: Install tools
        run: |
          go install gotest.tools/gotestsum@v1.12.0
          go install github.com/wadey/gocovmerge@latest

      # ========== UNIT TESTS (fail fast) ==========
      - name: Run unit tests with coverage
        run: |
          gotestsum --junitfile unit-results.xml -- \
            -coverprofile=unit-coverage.out \
            -covermode=atomic \
            ./...

      # ========== INTEGRATION TEST SETUP ==========
      - name: Restore testdata cache
        id: cache-testdata
        uses: actions/cache/restore@v4
        with:
          path: /tmp/mkvdup-testdata
          key: testdata-bbb-pal-cb67e9bc8e97b9d625e7cd7ee0d85e08

      - name: Delete existing cache (skip_cache only)
        if: github.event_name == 'workflow_dispatch' && inputs.skip_cache && steps.cache-testdata.outputs.cache-hit == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh cache delete testdata-bbb-pal-cb67e9bc8e97b9d625e7cd7ee0d85e08 --repo ${{ github.repository }} || true

      - name: Generate testdata
        if: steps.cache-testdata.outputs.cache-hit != 'true' || (github.event_name == 'workflow_dispatch' && inputs.skip_cache)
        run: ./testdata/generate-test-data.sh --output-dir /tmp/mkvdup-testdata

      - name: Save testdata cache
        # Only save cache on main branch to avoid duplicate caches per PR branch (10GB limit).
        # PRs can restore from main's cache but shouldn't create their own copies.
        if: github.ref == 'refs/heads/main' && (steps.cache-testdata.outputs.cache-hit != 'true' || (github.event_name == 'workflow_dispatch' && inputs.skip_cache))
        uses: actions/cache/save@v4
        with:
          path: /tmp/mkvdup-testdata
          key: testdata-bbb-pal-cb67e9bc8e97b9d625e7cd7ee0d85e08

      - name: Setup FUSE permissions
        run: |
          sudo modprobe fuse
          sudo chmod 666 /dev/fuse

      # ========== INTEGRATION TESTS ==========
      # Note: This also runs unit tests because -tags=integration includes all test files.
      # This is intentional - coverage merge will deduplicate, and re-running unit tests
      # ensures they pass with the integration build tag. The extra time is minimal.
      - name: Run integration tests with coverage
        env:
          MKVDUP_TESTDATA: /tmp/mkvdup-testdata
        run: |
          gotestsum --junitfile integration-results.xml -- \
            -tags=integration \
            -coverprofile=integration-coverage.out \
            -covermode=atomic \
            -timeout=30m \
            ./...

      # ========== MERGE COVERAGE ==========
      - name: Merge coverage profiles
        run: gocovmerge unit-coverage.out integration-coverage.out > merged-coverage.out

      - name: Generate coverage reports
        id: coverage
        run: |
          go tool cover -func=merged-coverage.out | tee coverage-summary.txt
          COVERAGE=$(go tool cover -func=merged-coverage.out | grep total | awk '{print $3}' | tr -d '%')
          echo "Total coverage: ${COVERAGE}%"
          echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT
          go tool cover -html=merged-coverage.out -o coverage.html

          cat > coverage.json << EOF
          {
            "coverage": ${COVERAGE},
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${GITHUB_SHA}"
          }
          EOF

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('coverage-summary.txt', 'utf8');
            const coverage = '${{ steps.coverage.outputs.coverage }}';

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const coverageComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('## Test Coverage Report')
            );

            const body = `## Test Coverage Report

            **Total Coverage: ${coverage}%** (unit + integration)

            <details>
            <summary>Coverage by function</summary>

            \`\`\`
            ${summary}
            \`\`\`

            </details>`;

            if (coverageComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: coverageComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: test-results
          path: |
            unit-results.xml
            integration-results.xml
            coverage.html
            coverage.json
            coverage-summary.txt

      - name: Publish coverage to gh-pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          BENCHMARK_PAT: ${{ secrets.BENCHMARK_PAT }}
        run: |
          if [ -z "$BENCHMARK_PAT" ]; then
            echo "WARNING: BENCHMARK_PAT not configured. Skipping gh-pages publish."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${BENCHMARK_PAT}@github.com/${{ github.repository }}.git"

          mkdir -p /tmp/coverage
          cp coverage.html /tmp/coverage/
          cp coverage.json /tmp/coverage/
          cp coverage-summary.txt /tmp/coverage/

          git fetch origin gh-pages
          git checkout gh-pages

          mkdir -p coverage
          cp /tmp/coverage/coverage.html coverage/index.html
          cp /tmp/coverage/coverage.json coverage/
          cp /tmp/coverage/coverage-summary.txt coverage/

          git add coverage/
          git diff --staged --quiet || git commit -m "Update coverage report [skip ci]"
          git pull --rebase origin gh-pages
          git push
