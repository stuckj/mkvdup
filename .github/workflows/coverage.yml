name: Coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.BENCHMARK_PAT }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse-dev

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest

      - name: Run tests with coverage
        run: gotestsum --junitfile test-results.xml --jsonfile test-results.json -- -coverprofile=coverage.out -covermode=atomic ./...

      - name: Generate coverage reports
        id: coverage
        run: |
          # Generate function coverage summary
          go tool cover -func=coverage.out | tee coverage-summary.txt

          # Extract total coverage percentage
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | tr -d '%')
          echo "Total coverage: ${COVERAGE}%"
          echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT

          # Generate HTML report
          go tool cover -html=coverage.out -o coverage.html

          # Extract test counts from gotestsum JSON output (only count test-level events, not package-level)
          TESTS_PASSED=$(jq -s '[.[] | select(.Action=="pass" and .Test != null and .Test != "")] | length' test-results.json)
          TESTS_FAILED=$(jq -s '[.[] | select(.Action=="fail" and .Test != null and .Test != "")] | length' test-results.json)
          TESTS_SKIPPED=$(jq -s '[.[] | select(.Action=="skip" and .Test != null and .Test != "")] | length' test-results.json)

          # Generate JSON for badge and tracking (includes test stats)
          cat > coverage.json << EOF
          {
            "coverage": ${COVERAGE},
            "tests_passed": ${TESTS_PASSED},
            "tests_failed": ${TESTS_FAILED},
            "tests_skipped": ${TESTS_SKIPPED},
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${GITHUB_SHA}"
          }
          EOF

          echo "tests_passed=${TESTS_PASSED}" >> $GITHUB_OUTPUT
          echo "tests_failed=${TESTS_FAILED}" >> $GITHUB_OUTPUT
          echo "tests_skipped=${TESTS_SKIPPED}" >> $GITHUB_OUTPUT

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('coverage-summary.txt', 'utf8');
            const coverage = '${{ steps.coverage.outputs.coverage }}';

            // Find existing coverage comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const coverageComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('## Test Coverage Report')
            );

            const body = `## Test Coverage Report

            **Total Coverage: ${coverage}%**

            <details>
            <summary>Coverage by function</summary>

            \`\`\`
            ${summary}
            \`\`\`

            </details>`;

            if (coverageComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: coverageComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Publish coverage to gh-pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Validate that BENCHMARK_PAT was configured
          if [ "${{ secrets.BENCHMARK_PAT }}" = "" ]; then
            echo "WARNING: BENCHMARK_PAT secret not configured. Skipping gh-pages publish."
            exit 0
          fi

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Save coverage and test files
          mkdir -p /tmp/coverage
          cp coverage.html /tmp/coverage/
          cp coverage.json /tmp/coverage/
          cp coverage-summary.txt /tmp/coverage/
          cp test-results.xml /tmp/coverage/
          cp test-results.json /tmp/coverage/

          # Switch to gh-pages branch
          git fetch origin gh-pages
          git checkout gh-pages

          # Create coverage directory if it doesn't exist
          mkdir -p coverage

          # Copy coverage files
          cp /tmp/coverage/coverage.html coverage/index.html
          cp /tmp/coverage/coverage.json coverage/
          cp /tmp/coverage/coverage-summary.txt coverage/
          cp /tmp/coverage/test-results.xml coverage/
          cp /tmp/coverage/test-results.json coverage/

          # Commit and push
          git add coverage/
          git diff --staged --quiet || git commit -m "Update coverage report [skip ci]"
          git pull --rebase origin gh-pages
          git push
