name: Coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_cache:
        description: 'Skip cache and regenerate testdata'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  # ========== UNIT TESTS (fast, no testdata needed) ==========
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse-dev fuse3

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@v1.12.0

      - name: Run unit tests with coverage
        run: |
          gotestsum --junitfile unit-results.xml -- \
            -coverprofile=unit-coverage.out \
            -covermode=atomic \
            -coverpkg=./... \
            ./...

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v6
        with:
          name: unit-coverage
          path: unit-coverage.out

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: unit-results
          path: unit-results.xml

  # ========== DVD INTEGRATION TESTS ==========
  integration-dvd:
    name: Integration Tests (DVD)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse-dev fuse3 nfs-kernel-server nfs-common

      - name: Start NFS services
        run: |
          sudo mkdir -p /etc/exports.d
          sudo systemctl start rpcbind
          sudo systemctl start nfs-server

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@v1.12.0

      - name: Restore testdata cache
        id: cache-testdata
        uses: actions/cache/restore@v5
        with:
          path: /tmp/mkvdup-testdata
          key: testdata-bbb-pal-cb67e9bc8e97b9d625e7cd7ee0d85e08

      - name: Delete existing cache (skip_cache only)
        if: github.event_name == 'workflow_dispatch' && inputs.skip_cache && steps.cache-testdata.outputs.cache-hit == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh cache delete testdata-bbb-pal-cb67e9bc8e97b9d625e7cd7ee0d85e08 --repo ${{ github.repository }} || true

      - name: Generate testdata
        if: steps.cache-testdata.outputs.cache-hit != 'true' || (github.event_name == 'workflow_dispatch' && inputs.skip_cache)
        run: ./testdata/generate-test-data.sh --output-dir /tmp/mkvdup-testdata

      - name: Save testdata cache
        if: github.ref == 'refs/heads/main' && (steps.cache-testdata.outputs.cache-hit != 'true' || (github.event_name == 'workflow_dispatch' && inputs.skip_cache))
        uses: actions/cache/save@v5
        with:
          path: /tmp/mkvdup-testdata
          key: testdata-bbb-pal-cb67e9bc8e97b9d625e7cd7ee0d85e08

      - name: Setup FUSE permissions
        run: |
          sudo modprobe fuse
          sudo chmod 666 /dev/fuse

      - name: Run DVD and FUSE integration tests with coverage
        env:
          MKVDUP_TESTDATA: /tmp/mkvdup-testdata
        run: |
          # Run dedup DVD tests (skip Blu-ray) and all FUSE tests
          # FUSE tests use DVD testdata, so they run here
          # sudo -E preserves MKVDUP_TESTDATA and enables NFS integration test
          GOTESTSUM=$(go env GOPATH)/bin/gotestsum
          sudo -E "$GOTESTSUM" --junitfile dvd-results.xml -- \
            -tags=integration \
            -skip 'TestFullDedupCycle_Bluray' \
            -coverprofile=dvd-coverage.out \
            -covermode=atomic \
            -coverpkg=./... \
            -timeout=0 \
            ./internal/dedup/... ./internal/fuse/...

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v6
        with:
          name: dvd-coverage
          path: dvd-coverage.out

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: dvd-results
          path: dvd-results.xml

  # ========== BLU-RAY INTEGRATION TESTS ==========
  integration-bluray:
    name: Integration Tests (Blu-ray)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse-dev fuse3 ffmpeg

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@v1.12.0

      - name: Restore testdata cache
        id: cache-testdata
        uses: actions/cache/restore@v5
        with:
          path: /tmp/mkvdup-testdata
          key: testdata-bbb-pal-cb67e9bc8e97b9d625e7cd7ee0d85e08

      - name: Delete existing cache (skip_cache only)
        if: github.event_name == 'workflow_dispatch' && inputs.skip_cache && steps.cache-testdata.outputs.cache-hit == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh cache delete testdata-bbb-pal-cb67e9bc8e97b9d625e7cd7ee0d85e08 --repo ${{ github.repository }} || true

      - name: Generate testdata
        if: steps.cache-testdata.outputs.cache-hit != 'true' || (github.event_name == 'workflow_dispatch' && inputs.skip_cache)
        run: ./testdata/generate-test-data.sh --output-dir /tmp/mkvdup-testdata

      - name: Save testdata cache
        if: github.ref == 'refs/heads/main' && (steps.cache-testdata.outputs.cache-hit != 'true' || (github.event_name == 'workflow_dispatch' && inputs.skip_cache))
        uses: actions/cache/save@v5
        with:
          path: /tmp/mkvdup-testdata
          key: testdata-bbb-pal-cb67e9bc8e97b9d625e7cd7ee0d85e08

      - name: Run Blu-ray integration tests with coverage
        env:
          MKVDUP_TESTDATA: /tmp/mkvdup-testdata
        run: |
          # Only run the Blu-ray dedup test (no FUSE tests - they run in DVD job)
          gotestsum --junitfile bluray-results.xml -- \
            -tags=integration \
            -run 'TestFullDedupCycle_Bluray' \
            -coverprofile=bluray-coverage.out \
            -covermode=atomic \
            -coverpkg=./... \
            -timeout=0 \
            ./internal/dedup/...

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v6
        with:
          name: bluray-coverage
          path: bluray-coverage.out

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: bluray-results
          path: bluray-results.xml

  # ========== MERGE COVERAGE AND REPORT ==========
  merge-coverage:
    name: Merge Coverage
    needs: [unit-tests, integration-dvd, integration-bluray]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Install gocovmerge
        run: go install github.com/wadey/gocovmerge@latest

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: '*-coverage'
          merge-multiple: true

      - name: List downloaded files
        run: ls -la *.out || echo "No .out files found"

      - name: Merge coverage profiles
        run: gocovmerge unit-coverage.out dvd-coverage.out bluray-coverage.out > merged-coverage.out

      - name: Generate coverage reports
        id: coverage
        run: |
          go tool cover -func=merged-coverage.out | tee coverage-summary.txt
          # Use $NF (last field) and exact match on "^total:" for robust parsing
          COVERAGE=$(go tool cover -func=merged-coverage.out | grep "^total:" | awk '{print $NF}' | tr -d '%')
          echo "Total coverage: ${COVERAGE}%"
          echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT
          go tool cover -html=merged-coverage.out -o coverage.html

          cat > coverage.json << EOF
          {
            "coverage": ${COVERAGE},
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${GITHUB_SHA}"
          }
          EOF

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('coverage-summary.txt', 'utf8');
            const coverage = '${{ steps.coverage.outputs.coverage }}';

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const coverageComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('## Test Coverage Report')
            );

            const body = `## Test Coverage Report

            **Total Coverage: ${coverage}%** (unit + DVD + Blu-ray integration)

            <details>
            <summary>Coverage by function</summary>

            \`\`\`
            ${summary}
            \`\`\`

            </details>`;

            if (coverageComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: coverageComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Download test results
        uses: actions/download-artifact@v7
        with:
          pattern: '*-results'
          merge-multiple: true

      - name: Upload combined results
        uses: actions/upload-artifact@v6
        with:
          name: test-results
          path: |
            unit-results.xml
            dvd-results.xml
            bluray-results.xml
            coverage.html
            coverage.json
            coverage-summary.txt

      - name: Publish coverage to gh-pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          BENCHMARK_PAT: ${{ secrets.BENCHMARK_PAT }}
        run: |
          if [ -z "$BENCHMARK_PAT" ]; then
            echo "WARNING: BENCHMARK_PAT not configured. Skipping gh-pages publish."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${BENCHMARK_PAT}@github.com/${{ github.repository }}.git"

          mkdir -p /tmp/coverage
          cp coverage.html /tmp/coverage/
          cp coverage.json /tmp/coverage/
          cp coverage-summary.txt /tmp/coverage/

          git fetch origin gh-pages
          git checkout gh-pages

          mkdir -p coverage
          cp /tmp/coverage/coverage.html coverage/index.html
          cp /tmp/coverage/coverage.json coverage/
          cp /tmp/coverage/coverage-summary.txt coverage/

          git add coverage/
          git diff --staged --quiet || git commit -m "Update coverage report [skip ci]"
          git pull --rebase origin gh-pages
          git push
