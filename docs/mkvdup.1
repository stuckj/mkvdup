.TH @PACKAGE_NAME_UPPER@ 1 "January 2026" "@PACKAGE_NAME@" "User Commands"
.SH NAME
@PACKAGE_NAME@ \- MKV deduplication tool using FUSE
.SH SYNOPSIS
.B @PACKAGE_NAME@
.RI [ OPTIONS ]
.I command
.RI [ ARGS ]
.SH DESCRIPTION
.B @PACKAGE_NAME@
reduces storage requirements for MKV files by referencing their source media
(DVD ISOs, Blu-ray backups). Since the underlying codec data is identical
between an MKV and its source, we store only the unique MKV data plus an index
mapping offsets. A 3.4GB MKV can be stored as approximately 50MB.
.SH COMMANDS
.TP
.B create \fR[\fIoptions\fR] \fImkv-file\fR \fIsource-dir\fR \fIoutput\fR [\fIname\fR]
Create a dedup file from an MKV and its source media.
Before matching, codecs in the MKV are compared against the source media.
If a mismatch is detected (e.g., MKV has H.264 but source is MPEG-2), you
will be prompted to continue or abort.
.RS
.TP
.I mkv-file
Path to the MKV file to deduplicate
.TP
.I source-dir
Directory containing source media (ISO files or BDMV folders)
.TP
.I output
Output .mkvdup file path.
.TP
.I name
Display name in FUSE mount (default: basename of mkv-file;
\fI.mkv\fR extension auto-added if missing).
Supports directory paths (e.g., "Movies/Action/Video1").
Directories are auto-created when mounted via FUSE.
.TP
.B \-\-warn\-threshold N
Minimum space savings percentage to avoid a warning (default: 75).
If the resulting dedup file achieves less than this percentage of savings,
a warning is printed suggesting wrong source or transcoded MKV.
.TP
.B \-\-quiet
Suppress the space savings warning entirely.
.TP
.B \-\-non\-interactive
Don't prompt on codec mismatch; show warning and continue.
Automatically enabled when stdin is not a terminal.
.RE
.TP
.B batch-create \fR[\fIoptions\fR] \fImanifest.yaml\fR
Create multiple dedup files from MKVs sharing the same source directory.
The source is indexed once and reused for all files. The YAML manifest
specifies the shared source directory and a list of MKV files to process.
Codec compatibility is checked for each file; if a mismatch is detected,
a warning is printed but processing continues (always non-interactive).
.RS
.TP
.I manifest.yaml
YAML manifest file specifying source directory and MKV files. See
.B BATCH MANIFEST FORMAT
for details.
.TP
.B \-\-warn\-threshold N
Minimum space savings percentage to avoid a warning (default: 75).
Files with savings below this threshold are listed in the batch summary.
.TP
.B \-\-quiet
Suppress the space savings warning entirely.
.RE
.TP
.B probe \fImkv-file\fR \fIsource-dir\fR...
Quick test to check if an MKV matches one or more source directories.
Useful for identifying which disc an MKV came from in multi-disc sets.
.RS
.TP
.I mkv-file
Path to the MKV file to test
.TP
.I source-dir
One or more directories to test against
.RE
.TP
.B mount \fR[\fIoptions\fR] \fImountpoint\fR [\fIconfig.yaml\fR...]
Mount dedup files as a FUSE filesystem.
.RS
.TP
.I mountpoint
Directory to mount the filesystem
.TP
.I config.yaml
YAML config files (default: /etc/mkvdup.conf)
.TP
.B \-\-allow\-other
Allow other users to access the mount
.TP
.B \-\-foreground
Run in foreground (for debugging or systemd). By default, @PACKAGE_NAME@ daemonizes
after the mount is ready and returns control to the caller.
.TP
.B \-\-config\-dir
Treat config argument as directory of YAML files (.yaml, .yml)
.TP
.B \-\-pid\-file PATH
Write the daemon PID to the specified file. Useful for init scripts.
.TP
.B \-\-daemon\-timeout DURATION
Timeout for waiting for the daemon to start (default: 30s). Accepts Go duration
format (e.g., 30s, 1m, 2m30s).
.TP
.B \-\-default\-uid UID
Default UID for files and directories (default: calling user's UID). For fstab
mounts (which run as root), this defaults to 0.
.TP
.B \-\-default\-gid GID
Default GID for files and directories (default: calling user's GID). For fstab
mounts (which run as root), this defaults to 0.
.TP
.B \-\-default\-file\-mode MODE
Default mode for files in octal (default: 0444).
.TP
.B \-\-default\-dir\-mode MODE
Default mode for directories in octal (default: 0555).
.TP
.B \-\-permissions\-file PATH
Path to permissions file (overrides default locations). See
.B FILES
section for default search order.
.RE
.TP
.B info \fIdedup-file\fR
Show information about a dedup file.
.RS
.TP
.I dedup-file
Path to the .mkvdup file
.RE
.TP
.B verify \fIdedup-file\fR \fIsource-dir\fR \fIoriginal-mkv\fR
Verify that a dedup file correctly reconstructs the original MKV.
.RS
.TP
.I dedup-file
Path to the .mkvdup file
.TP
.I source-dir
Directory containing the source media
.TP
.I original-mkv
Path to the original MKV for comparison
.RE
.TP
.B check \fR[\fIoptions\fR] \fIdedup-file\fR \fIsource-dir\fR
Check integrity of a dedup file and its source files without requiring
the original MKV. Verifies the dedup file's internal checksums, then checks
that all referenced source files exist with correct sizes. Optionally verifies
source file checksums.
.RS
.TP
.I dedup-file
Path to the .mkvdup file
.TP
.I source-dir
Directory containing the source media
.TP
.B \-\-source\-checksums
Verify source file checksums (reads entire source files)
.RE
.TP
.B validate \fR[\fIoptions\fR] \fIconfig.yaml\fR...
Validate configuration files for correctness before mounting.
.RS
.TP
.I config.yaml
YAML config files to validate
.TP
.B \-\-config\-dir
Treat config argument as directory of YAML files (.yaml, .yml)
.TP
.B \-\-deep
Verify dedup file headers and internal checksums
.TP
.B \-\-strict
Treat warnings as errors (exit code 1 on warnings)
.RE
.TP
.B reload \fR[\fIoptions\fR] \fB\-\-pid\-file\fR \fIPATH\fR [\fIconfig.yaml\fR...]
Reload a running daemon's configuration. Validates the config files
before sending SIGHUP to the daemon. If validation fails, the signal
is not sent and errors are reported. If no config files are specified,
the signal is sent without pre-validation.
.RS
.TP
.I config.yaml
Config files to validate (same as mount's config args)
.TP
.B \-\-pid\-file PATH
(Required) PID file of the running daemon
.TP
.B \-\-config\-dir
Treat config argument as directory of YAML files (.yaml, .yml)
.RE
.TP
.B deltadiag \fIdedup-file\fR \fImkv-file\fR
Analyze unmatched (delta) regions in a dedup file by cross-referencing with
the original MKV. Classifies delta bytes by stream type (video, audio,
container) and provides H.264 NAL type breakdown for video delta.
.RS
.TP
.I dedup-file
Path to the .mkvdup file
.TP
.I mkv-file
Path to the original MKV file
.RE
.TP
.B parse-mkv \fImkv-file\fR
Parse an MKV file and display packet information (debugging).
.TP
.B index-source \fIsource-dir\fR
Index a source directory and display statistics (debugging).
.TP
.B match \fImkv-file\fR \fIsource-dir\fR
Match MKV packets to source and show detailed results (debugging).
.SH OPTIONS
.TP
.BR \-v ", " \-\-verbose
Enable verbose output
.TP
.BR \-h ", " \-\-help
Show help message
.TP
.B \-\-version
Show version information
.SH EXAMPLES
Create a dedup file:
.PP
.RS
.nf
@PACKAGE_NAME@ create movie.mkv /media/dvd-backups
.fi
.RE
.PP
Batch create dedup files from a manifest:
.PP
.RS
.nf
mkvdup batch-create episodes.yaml
.fi
.RE
.PP
Test if MKV matches a source (useful for multi-disc sets):
.PP
.RS
.nf
@PACKAGE_NAME@ probe movie.mkv /media/disc1 /media/disc2 /media/disc3
.fi
.RE
.PP
Mount dedup files as virtual MKVs:
.PP
.RS
.nf
@PACKAGE_NAME@ mount /mnt/videos movie.mkvdup.yaml
.fi
.RE
.PP
Verify a dedup file:
.PP
.RS
.nf
@PACKAGE_NAME@ verify movie.mkvdup /media/dvd-backups original.mkv
.fi
.RE
.PP
Check dedup file and source integrity:
.PP
.RS
.nf
@PACKAGE_NAME@ check movie.mkvdup /media/dvd-backups
@PACKAGE_NAME@ check --source-checksums movie.mkvdup /media/dvd-backups
.fi
.RE
.PP
Validate config files before mounting:
.PP
.RS
.nf
@PACKAGE_NAME@ validate /etc/mkvdup.conf
@PACKAGE_NAME@ validate --deep --strict /etc/mkvdup.conf
@PACKAGE_NAME@ validate --config-dir /etc/mkvdup.d/
.fi
.RE
.PP
Reload a running daemon's configuration:
.PP
.RS
.nf
@PACKAGE_NAME@ reload --pid-file /run/mkvdup.pid /etc/mkvdup.conf
@PACKAGE_NAME@ reload --pid-file /run/mkvdup.pid --config-dir /etc/mkvdup.d/
.fi
.RE
.PP
Analyze unmatched regions in a dedup file:
.PP
.RS
.nf
@PACKAGE_NAME@ deltadiag movie.mkvdup original.mkv
.fi
.RE
.SH BATCH MANIFEST FORMAT
The YAML manifest for
.B batch-create
specifies a shared source directory and a list of MKV files to process:
.PP
.RS
.nf
source_dir: /media/dvd-backups/disc1

files:
  \- mkv: episode1.mkv
    output: episode1.mkvdup
    name: "Show/S01/Episode 1"

  \- mkv: episode2.mkv
    output: episode2.mkvdup

  \- mkv: /absolute/path/to/episode3.mkv
    output: /absolute/path/to/episode3.mkvdup
.fi
.RE
.PP
.B Fields:
.TP
.B source_dir
(Required) Shared source directory for all MKV files.
.TP
.B files
(Required) List of MKV files to process. Each entry supports:
.RS
.TP
.B mkv
(Required) Path to the MKV file.
.TP
.B output
(Required) Output .mkvdup file path.
.TP
.B name
(Optional) Display name in FUSE mount. Default: basename of \fImkv\fR.
The \fI.mkv\fR extension is auto-added if missing.
.RE
.PP
Relative paths are resolved against the manifest file's directory.
.PP
If any file fails, processing continues for remaining files. The exit code
is 1 if any file failed, 0 if all succeeded.
.SH CONFIG FILE FORMAT
The YAML config file for mounting specifies the dedup file, source directory,
and virtual file name:
.PP
.RS
.nf
name: "movie.mkv"
dedup_file: "/path/to/movie.mkvdup"
source_dir: "/path/to/source/dir"
.fi
.RE
.PP
The
.B name
field supports directory paths. Directories are auto-created in the FUSE mount:
.PP
.RS
.nf
name: "Movies/Action/Video1.mkv"
dedup_file: "video1.mkvdup"
source_dir: "/media/bluray/Video1"
.fi
.RE
.PP
Relative paths in
.B dedup_file
and
.B source_dir
are resolved relative to the directory of the config file that contains them.
When a config is included by another config, its relative paths are resolved
against its own directory, not the directory of the including config.
.SS Includes and Virtual Files
Any config file can include other configs via glob patterns and define
inline virtual files:
.PP
.RS
.nf
# Include other config files (glob patterns supported)
includes:
  \- "/data/dedup/*.mkvdup.yaml"
  \- "/isos/**/*.mkvdup.yaml"    # ** matches nested dirs

# Inline virtual file definitions
virtual_files:
  \- name: "Movies/Video1.mkv"
    dedup_file: "/data/video1.mkvdup"
    source_dir: "/data/sources/DVD"
.fi
.RE
.PP
Included configs can themselves contain
.B includes
(recursive). Circular includes are detected and skipped.
Relative include patterns are resolved against the including config file's directory.
.SH FSTAB AND SYSTEMD
@PACKAGE_NAME@ can be mounted via /etc/fstab or systemd mount units using the
mount.@PACKAGE_NAME@ helper script. The mount helper automatically enables
.B allow_other
so that root can access the filesystem for chown/chmod operations.
.SS fstab examples
Mount using a specific config file:
.PP
.RS
.nf
/etc/mkvdup.conf  /mnt/videos  fuse.@PACKAGE_NAME@  defaults  0  0
.fi
.RE
.PP
Mount using the default config with allow_other:
.PP
.RS
.nf
none  /mnt/videos  fuse.@PACKAGE_NAME@  defaults,allow_other  0  0
.fi
.RE
.PP
Mount using a directory of config files:
.PP
.RS
.nf
/etc/mkvdup.d  /mnt/videos  fuse.@PACKAGE_NAME@  config_dir  0  0
.fi
.RE
.SS systemd mount unit
Create a file like /etc/systemd/system/mnt-videos.mount:
.PP
.RS
.nf
[Unit]
Description=@PACKAGE_NAME@ FUSE mount
After=local-fs.target

[Mount]
What=/etc/mkvdup.conf
Where=/mnt/videos
Type=fuse.@PACKAGE_NAME@
Options=allow_other

[Install]
WantedBy=multi-user.target
.fi
.RE
.PP
Then enable and start:
.PP
.RS
.nf
systemctl enable mnt-videos.mount
systemctl start mnt-videos.mount
.fi
.RE
.SH EXIT STATUS
.TP
.B 0
Success
.TP
.B 1
General error (invalid arguments, file not found, etc.)
.SH FILES
.TP
.I /etc/mkvdup.conf
Default configuration file (used if no config specified)
.TP
.I /usr/sbin/mount.fuse.@PACKAGE_NAME@
Mount helper script for fstab/systemd integration
.TP
.I *.mkvdup
Dedup files containing the index and delta data
.TP
.I *.mkvdup.yaml
Config files for mounting dedup files
.SH FILE FORMAT
The .mkvdup file format is versioned. The writer produces V5 (DVD) or V6
(Blu-ray) files by default; older versions are supported for reading.
.PP
.B Version 6 (current, Blu-ray):
V4 with an embedded creator version string after the header. The on-disk
layout of index entries and range maps is identical to V4.
.PP
.B Version 5 (current, DVD):
V3 with an embedded creator version string after the header. The on-disk
layout of index entries and source references is identical to V3.
.PP
.B Version 4 (Blu-ray):
Adds embedded range map section for Blu-ray M2TS sources.
Index entries use ES offsets; the range map translates ES offsets to
raw file offsets at read time.
.PP
.B Version 3 (DVD):
Source type awareness and multi-source-file support.
Stores raw file offsets for all source references.
.PP
.B Version 2 (deprecated):
Stores raw file offsets for all source references.
.PP
.B Version 1 (deprecated):
Used elementary stream (ES) offsets for DVD sources.
.PP
Deprecated version files must be recreated using the
.B create
command.
.PP
Use
.B @PACKAGE_NAME@ info
to check the format version of a dedup file.
.SH SEE ALSO
.BR fusermount (1),
.BR ffmpeg (1),
.BR mkvmerge (1)
.SH BUGS
Report bugs at https://github.com/stuckj/mkvdup/issues
.SH AUTHOR
Written by stuckj.
.SH COPYRIGHT
MIT License
