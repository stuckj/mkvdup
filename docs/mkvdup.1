.TH @PACKAGE_NAME_UPPER@ 1 "January 2026" "@PACKAGE_NAME@" "User Commands"
.SH NAME
@PACKAGE_NAME@ \- MKV deduplication tool using FUSE
.SH SYNOPSIS
.B @PACKAGE_NAME@
.RI [ OPTIONS ]
.I command
.RI [ ARGS ]
.SH DESCRIPTION
.B @PACKAGE_NAME@
reduces storage requirements for MKV files by referencing their source media
(DVD ISOs, Blu-ray backups). Since the underlying codec data is identical
between an MKV and its source, we store only the unique MKV data plus an index
mapping offsets. A 3.4GB MKV can be stored as approximately 50MB.
.SH COMMANDS
.TP
.B create \fR[\fIoptions\fR] \fImkv-file\fR \fIsource-dir\fR \fIoutput\fR [\fIname\fR]
Create a dedup file from an MKV and its source media.
Before matching, codecs in the MKV are compared against the source media.
If a mismatch is detected (e.g., MKV has H.264 but source is MPEG-2), you
will be prompted to continue or abort.
.RS
.TP
.I mkv-file
Path to the MKV file to deduplicate
.TP
.I source-dir
Directory containing source media (ISO files or BDMV folders)
.TP
.I output
Output .mkvdup file path.
.TP
.I name
Display name in FUSE mount (default: basename of mkv-file;
\fI.mkv\fR extension auto-added if missing).
Supports directory paths (e.g., "Movies/Action/Video1").
Directories are auto-created when mounted via FUSE.
.TP
.B \-\-warn\-threshold N
Minimum space savings percentage to avoid a warning (default: 75).
If the resulting dedup file achieves less than this percentage of savings,
a warning is printed suggesting wrong source or transcoded MKV.
.TP
.B \-\-non\-interactive
Don't prompt on codec mismatch; show warning and continue.
Automatically enabled when stdin is not a terminal.
.RE
.TP
.B batch-create \fR[\fIoptions\fR] \fImanifest.yaml\fR
Create multiple dedup files from a YAML manifest. Files sharing the same
source directory are grouped and the source is indexed once per group.
A single manifest can reference multiple source directories.
Codec compatibility is checked for each file; if a mismatch is detected,
a warning is printed but processing continues (always non-interactive).
Use
.B \-\-skip\-codec\-mismatch
to skip mismatched files instead.
.RS
.TP
.I manifest.yaml
YAML manifest file specifying source directory(ies) and MKV files. See
.B BATCH MANIFEST FORMAT
for details.
.TP
.B \-\-warn\-threshold N
Minimum space savings percentage to avoid a warning (default: 75).
Files with savings below this threshold are listed in the batch summary.
.TP
.B \-\-skip\-codec\-mismatch
Skip MKVs with codec mismatch instead of processing them.
Mismatched files are reported as SKIP in the batch summary.
.RE
.TP
.B probe \fImkv-file\fR... \fB\-\-\fR \fIsource-dir\fR...
Quick test to check if MKV file(s) match one or more source directories.
When multiple MKVs are provided, each source is indexed only once.
Useful for identifying which disc an MKV came from in multi-disc sets.
For backward compatibility, a single MKV without \fB\-\-\fR is also supported.
.RS
.TP
.I mkv-file
One or more MKV files to test (before \fB\-\-\fR)
.TP
.B \-\-
Separator between MKV files and source directories
.TP
.I source-dir
One or more directories to test against (after \fB\-\-\fR)
.RE
.TP
.B mount \fR[\fIoptions\fR] \fImountpoint\fR [\fIconfig.yaml\fR...]
Mount dedup files as a FUSE filesystem.
.RS
.TP
.I mountpoint
Directory to mount the filesystem
.TP
.I config.yaml
YAML config files (default: /etc/mkvdup.conf)
.TP
.B \-\-allow\-other
Allow other users to access the mount
.TP
.B \-\-foreground
Run in foreground (for debugging or systemd). By default, @PACKAGE_NAME@ daemonizes
after the mount is ready and returns control to the caller.
.TP
.B \-\-config\-dir
Treat config argument as directory of YAML files (.yaml, .yml)
.TP
.B \-\-pid\-file PATH
Write the daemon PID to the specified file. Useful for init scripts.
.TP
.B \-\-daemon\-timeout DURATION
Timeout for waiting for the daemon to start (default: 30s). Accepts Go duration
format (e.g., 30s, 1m, 2m30s).
.TP
.B \-\-default\-uid UID
Default UID for files and directories (default: calling user's UID). For fstab
mounts (which run as root), this defaults to 0.
.TP
.B \-\-default\-gid GID
Default GID for files and directories (default: calling user's GID). For fstab
mounts (which run as root), this defaults to 0.
.TP
.B \-\-default\-file\-mode MODE
Default mode for files in octal (default: 0444).
.TP
.B \-\-default\-dir\-mode MODE
Default mode for directories in octal (default: 0555).
.TP
.B \-\-permissions\-file PATH
Path to permissions file (overrides default locations). See
.B FILES
section for default search order.
.TP
.B \-\-no\-source\-watch
Disable source file monitoring. By default, @PACKAGE_NAME@ monitors source
files (DVD ISOs, Blu-ray M2TS) for changes using inotify (local) or polling
(network filesystems).
.TP
.B \-\-on\-source\-change ACTION
Action to take when a source file change is detected. Default: \fBchecksum\fR.
.RS
.TP
.B warn
Log a warning with the source path and affected virtual files.
.TP
.B disable
Disable affected virtual files; subsequent reads return EIO.
Files remain visible in directory listings. Reversible via SIGHUP reload.
.TP
.B checksum
If the source file size changed, disable immediately (reads return EIO).
If only the timestamp changed (e.g., touch), verify the source file's
xxhash checksum in the background while the file remains accessible.
Disable only on checksum mismatch. If a subsequent verification passes,
the file is automatically re-enabled. Checksum verifications run
sequentially to avoid I/O storms.
.RE
.TP
.B \-\-source\-watch\-poll\-interval \fIDURATION\fR
Polling interval for detecting source file changes on network filesystems.
Accepts Go duration format (e.g., 10s, 1m, 5m). Default: 60s.
.TP
.B \-\-source\-read\-timeout \fIDURATION\fR
Read timeout for source files on network filesystems (NFS, CIFS/SMB).
When source media is on a network mount, individual read operations will
time out after this duration. Accepts Go duration format. Default: 30s.
.RE
.TP
.B info \fR[\fIoptions\fR] \fIdedup-file\fR
Show information about a dedup file.
.RS
.TP
.I dedup-file
Path to the .mkvdup file
.TP
.B \-\-hide\-unused\-files
Hide source files not referenced by any index entry.
For V7/V8 dedup files, unused source files are normally shown with
an \fI(unused)\fR marker; this option omits them entirely.
.RE
.TP
.B verify \fIdedup-file\fR \fIsource-dir\fR \fIoriginal-mkv\fR
Verify that a dedup file correctly reconstructs the original MKV.
.RS
.TP
.I dedup-file
Path to the .mkvdup file
.TP
.I source-dir
Directory containing the source media
.TP
.I original-mkv
Path to the original MKV for comparison
.RE
.TP
.B extract \fIdedup-file\fR \fIsource-dir\fR \fIoutput-mkv\fR
Rebuild the original MKV from a dedup file and source media.
.RS
.TP
.I dedup-file
Path to the .mkvdup file
.TP
.I source-dir
Directory containing the source media
.TP
.I output-mkv
Path for the reconstructed MKV file
.RE
.TP
.B check \fR[\fIoptions\fR] \fIdedup-file\fR \fIsource-dir\fR
Check integrity of a dedup file and its source files without requiring
the original MKV. Verifies the dedup file's internal checksums, then checks
that all referenced source files exist with correct sizes. Optionally verifies
source file checksums.
.RS
.TP
.I dedup-file
Path to the .mkvdup file
.TP
.I source-dir
Directory containing the source media
.TP
.B \-\-source\-checksums
Verify source file checksums (reads entire source files)
.RE
.TP
.B stats \fR[\fIoptions\fR] \fIconfig.yaml\fR...
Show space savings and file statistics for mkvdup-managed files.
Reads config files (same format as mount/validate) and reports per-file
statistics including original MKV size, dedup file size, space savings,
source type, and source directory. When multiple files are present, a
rollup summary shows aggregate totals.
.RS
.TP
.I config.yaml
YAML config files to analyze
.TP
.B \-\-config\-dir
Treat config argument as directory of YAML files (.yaml, .yml)
.RE
.TP
.B validate \fR[\fIoptions\fR] \fIconfig.yaml\fR...
Validate configuration files for correctness before mounting.
.RS
.TP
.I config.yaml
YAML config files to validate
.TP
.B \-\-config\-dir
Treat config argument as directory of YAML files (.yaml, .yml)
.TP
.B \-\-deep
Verify dedup file headers and internal checksums
.TP
.B \-\-strict
Treat warnings as errors (exit code 1 on warnings)
.RE
.TP
.B reload \fR[\fIoptions\fR] {\fB\-\-pid\-file\fR \fIPATH\fR | \fB\-\-pid\fR \fIPID\fR} [\fIconfig.yaml\fR...]
Reload a running daemon's configuration. Validates the config files
before sending SIGHUP to the daemon. If validation fails, the signal
is not sent and errors are reported. If no config files are specified,
the signal is sent without pre-validation.
.RS
.TP
.I config.yaml
Config files to validate (same as mount's config args)
.TP
.B \-\-pid\-file PATH
PID file of the running daemon (mutually exclusive with \fB\-\-pid\fR)
.TP
.B \-\-pid PID
PID of the running daemon, e.g. for foreground mode (mutually exclusive with \fB\-\-pid\-file\fR)
.TP
.B \-\-config\-dir
Treat config argument as directory of YAML files (.yaml, .yml)
.RE
.TP
.B deltadiag \fIdedup-file\fR \fImkv-file\fR
Analyze unmatched (delta) regions in a dedup file by cross-referencing with
the original MKV. Classifies delta bytes by stream type (video, audio,
container) and provides H.264 NAL type breakdown for video delta.
.RS
.TP
.I dedup-file
Path to the .mkvdup file
.TP
.I mkv-file
Path to the original MKV file
.RE
.TP
.B parse-mkv \fImkv-file\fR
Parse an MKV file and display packet information (debugging).
.TP
.B index-source \fIsource-dir\fR
Index a source directory and display statistics (debugging).
.TP
.B match \fImkv-file\fR \fIsource-dir\fR
Match MKV packets to source and show detailed results (debugging).
.SH OPTIONS
.TP
.BR \-v ", " \-\-verbose
Enable verbose output
.TP
.BR \-q ", " \-\-quiet
Suppress informational progress output. Errors still go to stderr.
Implies
.BR \-\-no\-progress .
.TP
.B \-\-no\-progress
Disable progress bars. Phase labels and completion times are still printed.
Milestone percentages are printed at 10% intervals. Automatically enabled
when stdout is not a terminal.
.TP
.B \-\-log\-file \fIPATH\fR
Duplicate all informational output to the specified file. The log file uses
non-TTY style: milestone percentages at 10% intervals instead of progress
bars, no ANSI escape sequences. Output is written regardless of
.BR \-\-quiet .
.TP
.BR \-h ", " \-\-help
Show help message
.TP
.B \-\-version
Show version information
.SH EXAMPLES
Create a dedup file:
.PP
.RS
.nf
@PACKAGE_NAME@ create movie.mkv /media/dvd-backups
.fi
.RE
.PP
Batch create dedup files from a manifest:
.PP
.RS
.nf
mkvdup batch-create episodes.yaml
.fi
.RE
.PP
Test if MKV matches a source (useful for multi-disc sets):
.PP
.RS
.nf
@PACKAGE_NAME@ probe movie.mkv /media/disc1 /media/disc2
@PACKAGE_NAME@ probe ep1.mkv ep2.mkv ep3.mkv -- /media/disc1 /media/disc2
.fi
.RE
.PP
Mount dedup files as virtual MKVs:
.PP
.RS
.nf
@PACKAGE_NAME@ mount /mnt/videos movie.mkvdup.yaml
.fi
.RE
.PP
Verify a dedup file:
.PP
.RS
.nf
@PACKAGE_NAME@ verify movie.mkvdup /media/dvd-backups original.mkv
.fi
.RE
.PP
Extract/rebuild the original MKV:
.PP
.RS
.nf
@PACKAGE_NAME@ extract movie.mkvdup /media/dvd-backups restored-movie.mkv
.fi
.RE
.PP
Check dedup file and source integrity:
.PP
.RS
.nf
@PACKAGE_NAME@ check movie.mkvdup /media/dvd-backups
@PACKAGE_NAME@ check --source-checksums movie.mkvdup /media/dvd-backups
.fi
.RE
.PP
Validate config files before mounting:
.PP
.RS
.nf
@PACKAGE_NAME@ validate /etc/mkvdup.conf
@PACKAGE_NAME@ validate --deep --strict /etc/mkvdup.conf
@PACKAGE_NAME@ validate --config-dir /etc/mkvdup.d/
.fi
.RE
.PP
Reload a running daemon's configuration:
.PP
.RS
.nf
@PACKAGE_NAME@ reload --pid-file /run/mkvdup.pid /etc/mkvdup.conf
@PACKAGE_NAME@ reload --pid-file /run/mkvdup.pid --config-dir /etc/mkvdup.d/
@PACKAGE_NAME@ reload --pid $(pidof mkvdup)
.fi
.RE
.PP
Analyze unmatched regions in a dedup file:
.PP
.RS
.nf
@PACKAGE_NAME@ deltadiag movie.mkvdup original.mkv
.fi
.RE
.SH BATCH MANIFEST FORMAT
The YAML manifest for
.B batch-create
specifies source directory(ies) and a list of MKV files to process:
.PP
.RS
.nf
source_dir: /media/dvd-backups/disc1   # default for all files

files:
  \- mkv: episode1.mkv
    output: episode1.mkvdup
    name: "Show/S01/Episode 1"

  \- mkv: episode2.mkv
    output: episode2.mkvdup

  \- mkv: movie.mkv
    output: movie.mkvdup
    source_dir: /media/dvd-backups/disc2  # per-file override
.fi
.RE
.PP
.B Fields:
.TP
.B source_dir
(Optional) Default source directory for files that don't specify their own.
At least one of top-level \fBsource_dir\fR or per-file \fBsource_dir\fR
must be set for every file entry.
.TP
.B files
(Required) List of MKV files to process. Each entry supports:
.RS
.TP
.B mkv
(Required) Path to the MKV file.
.TP
.B output
(Required) Output .mkvdup file path.
.TP
.B source_dir
(Optional) Source directory for this file. Overrides the top-level default.
.TP
.B name
(Optional) Display name in FUSE mount. Default: basename of \fImkv\fR.
The \fI.mkv\fR extension is auto-added if missing.
.RE
.PP
Files sharing the same source directory are grouped and the source is
indexed once per group.
.PP
Relative paths are resolved against the manifest file's directory.
.PP
If any file fails, processing continues for remaining files. If indexing
fails for one source, all files in that group are marked as failed and
processing continues with the next source. The exit code is 1 if any
file failed, 0 if all succeeded.
.SH CONFIG FILE FORMAT
The YAML config file for mounting specifies the dedup file, source directory,
and virtual file name:
.PP
.RS
.nf
name: "movie.mkv"
dedup_file: "/path/to/movie.mkvdup"
source_dir: "/path/to/source/dir"
.fi
.RE
.PP
The
.B name
field supports directory paths. Directories are auto-created in the FUSE mount:
.PP
.RS
.nf
name: "Movies/Action/Video1.mkv"
dedup_file: "video1.mkvdup"
source_dir: "/media/bluray/Video1"
.fi
.RE
.PP
Relative paths in
.B dedup_file
and
.B source_dir
are resolved relative to the directory of the config file that contains them.
When a config is included by another config, its relative paths are resolved
against its own directory, not the directory of the including config.
.SS Includes and Virtual Files
Any config file can include other configs via glob patterns and define
inline virtual files:
.PP
.RS
.nf
# Include other config files (glob patterns supported)
includes:
  \- "/data/dedup/*.mkvdup.yaml"
  \- "/isos/**/*.mkvdup.yaml"    # ** matches nested dirs

# Inline virtual file definitions
virtual_files:
  \- name: "Movies/Video1.mkv"
    dedup_file: "/data/video1.mkvdup"
    source_dir: "/data/sources/DVD"
.fi
.RE
.PP
Included configs can themselves contain
.B includes
(recursive). Circular includes are detected and skipped.
Relative include patterns are resolved against the including config file's directory.
.SH FSTAB AND SYSTEMD
@PACKAGE_NAME@ can be mounted via /etc/fstab or systemd mount units using the
mount.@PACKAGE_NAME@ helper script. The mount helper automatically enables
.B allow_other
so that root can access the filesystem for chown/chmod operations.
.SS fstab examples
Mount using a specific config file:
.PP
.RS
.nf
/etc/mkvdup.conf  /mnt/videos  fuse.@PACKAGE_NAME@  defaults  0  0
.fi
.RE
.PP
Mount using the default config with allow_other:
.PP
.RS
.nf
none  /mnt/videos  fuse.@PACKAGE_NAME@  defaults,allow_other  0  0
.fi
.RE
.PP
Mount using a directory of config files:
.PP
.RS
.nf
/etc/mkvdup.d  /mnt/videos  fuse.@PACKAGE_NAME@  config_dir  0  0
.fi
.RE
.PP
Mount with source file watching disabled:
.PP
.RS
.nf
/etc/mkvdup.conf  /mnt/videos  fuse.@PACKAGE_NAME@  no_source_watch  0  0
.fi
.RE
.PP
Mount with checksum verification on source change:
.PP
.RS
.nf
/etc/mkvdup.conf  /mnt/videos  fuse.@PACKAGE_NAME@  on_source_change=checksum  0  0
.fi
.RE
.PP
Mount with a PID file (for use with \fBmkvdup reload\fR):
.PP
.RS
.nf
/etc/mkvdup.conf  /mnt/videos  fuse.@PACKAGE_NAME@  pid_file=/run/mkvdup.pid  0  0
.fi
.RE
.SS systemd mount unit
Create a file like /etc/systemd/system/mnt-videos.mount:
.PP
.RS
.nf
[Unit]
Description=@PACKAGE_NAME@ FUSE mount
After=local-fs.target

[Mount]
What=/etc/mkvdup.conf
Where=/mnt/videos
Type=fuse.@PACKAGE_NAME@
Options=allow_other

[Install]
WantedBy=multi-user.target
.fi
.RE
.PP
Then enable and start:
.PP
.RS
.nf
systemctl enable mnt-videos.mount
systemctl start mnt-videos.mount
.fi
.RE
.SH EXIT STATUS
.TP
.B 0
Success
.TP
.B 1
General error (invalid arguments, file not found, etc.)
.SH FILES
.TP
.I /etc/mkvdup.conf
Default configuration file (used if no config specified)
.TP
.I /usr/sbin/mount.fuse.@PACKAGE_NAME@
Mount helper script for fstab/systemd integration
.TP
.I *.mkvdup
Dedup files containing the index and delta data
.TP
.I *.mkvdup.yaml
Config files for mounting dedup files
.SH FILE FORMAT
The .mkvdup file format is versioned. The writer produces V7 (DVD) or V8
(Blu-ray) files by default; older versions are supported for reading.
.PP
.B Version 8 (current, Blu-ray):
V6 with a per-source-file Used byte indicating whether each source file
is referenced by any index entry.
.PP
.B Version 7 (current, DVD):
V5 with a per-source-file Used byte indicating whether each source file
is referenced by any index entry.
.PP
.B Version 6 (Blu-ray):
V4 with an embedded creator version string after the header. The on-disk
layout of index entries and range maps is identical to V4.
.PP
.B Version 5 (DVD):
V3 with an embedded creator version string after the header. The on-disk
layout of index entries and source references is identical to V3.
.PP
.B Version 4 (Blu-ray):
Adds embedded range map section for Blu-ray M2TS sources.
Index entries use ES offsets; the range map translates ES offsets to
raw file offsets at read time.
.PP
.B Version 3 (DVD):
Source type awareness and multi-source-file support.
Stores raw file offsets for all source references.
.PP
.B Version 2 (deprecated):
Stores raw file offsets for all source references.
.PP
.B Version 1 (deprecated):
Used elementary stream (ES) offsets for DVD sources.
.PP
Deprecated version files must be recreated using the
.B create
command.
.PP
Use
.B @PACKAGE_NAME@ info
to check the format version of a dedup file.
.SH SEE ALSO
.BR fusermount (1),
.BR ffmpeg (1),
.BR mkvmerge (1)
.SH BUGS
Report bugs at https://github.com/stuckj/mkvdup/issues
.SH AUTHOR
Written by stuckj.
.SH COPYRIGHT
MIT License
